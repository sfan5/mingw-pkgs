#!/bin/bash -eu

. ./common.sh
common_init "$@"

pkgver=2.1.0-beta3
fetch_web "http://luajit.org/download/LuaJIT-$pkgver.tar.gz" \
	1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3
unpack_tar "LuaJIT-$pkgver.tar.gz" --strip-components=1

extra=-m${MINGW_TYPE#win}
[ "$MINGW_TYPE" = "win64" ] && \
	sed '/ENABLE_GC64/ s|^#||' -i src/Makefile
make \
	HOST_CC="cc $extra" BUILDMODE=static \
	CROSS=$MINGW_PREFIX- TARGET_SYS=Windows \
	amalg

mkdir -p $INSTALL_DIR/include
cp src/*.h $INSTALL_DIR/include
cp src/luajit.exe src/libluajit.a $INSTALL_DIR

package $pkgver
