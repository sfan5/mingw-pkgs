#!/bin/bash -eu

. ./common.sh
common_init "$@"

pkgver=2.2.4
fetch_web "https://github.com/libgd/libgd/releases/download/gd-$pkgver/libgd-$pkgver.tar.xz" \
	137f13a7eb93ce72e32ccd7cebdab6874f8cf7ddf31d3a455a68e016ecd9e4e6
unpack_tar "libgd-$pkgver.tar.xz" --strip-components=1

sed '/HAVE_LIBPNG_TRUE/ s|webpng\S*||' -i src/Makefile.in
PKG_CONFIG=/bin/false \
./configure --host=$MINGW_PREFIX --prefix=/ --with-png=$(depend_get_path libpng) \
	 --without-x --disable-werror
make -j$MAKE_JOBS

make DESTDIR=$INSTALL_DIR install
rm -rf $INSTALL_DIR/{lib/*.la,lib/pkgconfig} # no pkg-config on windows
rm -f $INSTALL_DIR/bin/{*.exe,bdftogd} # remove obscure utilities

package $pkgver